async function fingerprint(){const d=[navigator.userAgent,Intl.DateTimeFormat().resolvedOptions().timeZone,screen.width+'x'+screen.height,new Date().getTimezoneOffset()].join('|');const u=new TextEncoder().encode(d);const b=await crypto.subtle.digest('SHA-256',u);return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('')}
async function fetchWaiver(){const r=await fetch('/.netlify/functions/waiver_text');const j=await r.json();document.getElementById('waiverText').textContent=j.text}
async function sendCode(){const n=document.getElementById('fullName').value.trim(),e=document.getElementById('email').value.trim(),m=document.getElementById('mobile').value.trim(),s=document.getElementById('signature').value.trim(),a=document.getElementById('agree').checked,c=document.getElementById('channel').value;if(!n||!s||!a){alert('Please fill name, signature, and agree to Waiver v7.');return}if(c==='sms'&&!m){alert('Mobile is required for SMS.');return}if(c==='email'&&!e){alert('Email is required.');return}const fp=await fingerprint();const res=await fetch('/.netlify/functions/send_verification',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({fullName:n,email:e,mobile:m,signature:s,channel:c,fingerprint:fp})});const data=await res.json();if(data.ok){document.getElementById('verifyArea').classList.remove('hidden');document.getElementById('verifyMsg').textContent='Code sent. Check your '+(c==='sms'?'phone':'email')+'.'}else{alert('Error: '+data.error)}}
async function verifyCode(){const code=document.getElementById('code').value.trim();const res=await fetch('/.netlify/functions/verify_code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});const data=await res.json();document.getElementById('verifyMsg').textContent=data.ok?'Success! RSVP confirmed and Waiver v7 signed.':'Verification failed: '+data.error}
document.getElementById('btnSendCode').addEventListener('click',sendCode);document.getElementById('btnVerify').addEventListener('click',verifyCode);fetchWaiver();